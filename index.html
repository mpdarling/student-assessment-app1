<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Assessment" />
  <title>Student Assessment App</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 420px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; min-height: calc(100vh - 40px); }
    .header { background: #2563eb; color: white; padding: 16px 20px; text-align: center; position: relative; }
    .header h1 { font-size: 22px; font-weight: 700; }
    .header p { opacity: 0.95; font-size: 13px; }
    .offline-banner { margin-top: 8px; background: #f59e0b; color: #111827; font-weight: 600; padding: 6px 10px; border-radius: 10px; display: none; }
    .content { padding: 24px 18px 28px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .question { margin-bottom: 16px; }
    .question-label { display: block; font-weight: 700; color: #1e40af; margin-bottom: 6px; font-size: 15px; }
    select, .selectlike {
      width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white; transition: border-color 0.2s; cursor: pointer;
    }
    select:focus, .selectlike:focus { outline: none; border-color: #2563eb; }
    .btn { padding: 10px 14px; background: #2563eb; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .btn:hover { background: #1d4ed8; }
    .btn.secondary { background: #6b7280; }
    .btn.secondary:hover { background: #4b5563; }
    .btn.block { width: 100%; padding: 16px; border-radius: 12px; font-size: 18px; margin-top: 16px; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .btn.enabled { background: #2563eb; }
    .btn.enabled:hover { background: #1d4ed8; }
    .skill-attributes { margin-top: 12px; }
    .attribute-item { display: flex; align-items: center; padding: 10px; margin: 6px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: #fef2f2; border: 2px solid #fca5a5; }
    .attribute-item.checked { background: #f0fdf4; border-color: #4ade80; }
    .attribute-checkbox { width: 18px; height: 18px; border-radius: 6px; border: 2px solid #fca5a5; background: white; margin-right: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .attribute-item.checked .attribute-checkbox { background: #4ade80; border-color: #4ade80; }
    .attribute-checkbox::after { content: '‚úì'; color: white; font-weight: 700; opacity: 0; transition: opacity 0.2s; font-size: 12px; }
    .attribute-item.checked .attribute-checkbox::after { opacity: 1; }
    .attribute-text { flex: 1; font-weight: 500; }
    .loading { text-align: center; padding: 32px 20px; color: #6b7280; }
    .error { background: #fef2f2; border: 1px solid #fca5a5; color: #dc2626; padding: 12px; border-radius: 8px; margin: 10px 0; }
    .success-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 26px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 1000; text-align: center; display: none; }
    .success-popup.show { display: block; }
    .success-popup h3 { color: #059669; margin-bottom: 8px; }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
    .overlay.show { display: block; }
    .roster-label { font-size: 14px; color: #374151; margin: -2px 0 10px 0; }
    .inline-actions { display: flex; gap: 8px; }

    /* Multi-select dropdown */
    .ms-wrapper { position: relative; }
    .ms-button { display: flex; align-items: center; justify-content: space-between; }
    .ms-panel {
      position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: #fff; border: 2px solid #e5e7eb;
      border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.12); max-height: 260px; overflow: auto; z-index: 30; display: none;
    }
    .ms-panel.show { display: block; }
    .ms-item { padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .ms-item:hover { background: #f3f4f6; }
    .ms-item.selected { background: #eff6ff; }
    .ms-count { font-size: 12px; margin-left: 10px; color: #6b7280; }
    .ms-item.zero .ms-name { color: #111827; font-weight: 600; } /* 0 = black/high priority */
    .ms-item.nonzero .ms-name { color: #6b7280; }                /* 1+ = grey/lower priority */
    .selected-list { margin-top: 8px; }
    .selected-row { padding: 6px 8px; border: 1px dashed #e5e7eb; border-radius: 8px; margin: 4px 0; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .remove-link { color: #2563eb; font-weight: 700; cursor: pointer; }

    /* Home screen menu buttons */
    .menu-buttons { margin-top: 40px; }
    .menu-btn { width: 100%; padding: 20px; margin: 12px 0; background: #2563eb; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .menu-btn:hover { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 8px 16px rgba(37,99,235,0.3); }
    .menu-icon { font-size: 24px; }
    .menu-subtitle { font-size: 14px; opacity: 0.9; margin-top: 40px; text-align: center; color: #6b7280; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Student Assessment</h1>
      <p>Evaluate student skills and progress</p>
      <div class="offline-banner" id="offline-banner">Offline Mode</div>
    </div>

    <div class="content">
      <!-- Loading Screen -->
      <div id="loading-screen" class="screen active">
        <div class="loading">
          <p>Loading data from spreadsheet...</p>
          <div id="error-message" class="error" style="display:none;"></div>
        </div>
      </div>

      <!-- Home Screen - New Menu -->
      <div id="home-screen" class="screen">
        <div class="topbar">
          <div></div>
          <button class="btn secondary" id="refresh-btn-home">Refresh</button>
        </div>

        <div class="menu-buttons">
          <button class="menu-btn" id="assess-btn">
            <span class="menu-icon">üìù</span>
            <span>Assess Students</span>
          </button>
          
          <button class="menu-btn" id="email-btn">
            <span class="menu-icon">‚úâÔ∏è</span>
            <span>Email Students Assessment Link</span>
          </button>
        </div>

        <p class="menu-subtitle">Choose an action to continue</p>
      </div>

      <!-- Email Screen -->
      <div id="email-screen" class="screen">
        <div class="topbar">
          <button class="btn secondary" id="back-btn-email">Back</button>
          <button class="btn secondary" id="refresh-btn-email">Refresh</button>
        </div>

        <div class="question">
          <label class="question-label">Select Roster</label>
          <select id="email-roster-select">
            <option value="">Select a roster...</option>
          </select>
        </div>

        <div class="question">
          <label class="question-label">Select Skill</label>
          <select id="email-skill-select">
            <option value="">Select a skill...</option>
          </select>
        </div>

        <button class="btn block" id="send-email-btn" disabled>Send Email</button>
      </div>

      <!-- Assessment Screen 1 (previously screen1) -->
      <div id="screen1" class="screen">
        <div class="topbar">
          <button class="btn secondary" id="back-btn-assess">Back</button>
          <button class="btn secondary" id="refresh-btn-1">Refresh</button>
        </div>

        <div class="question">
          <label class="question-label">Who are you?</label>
          <select id="teacher-select">
            <option value="">Select a teacher...</option>
          </select>
        </div>

        <div class="question">
          <label class="question-label">Which group (roster) do you want to assess?</label>
          <select id="class-select">
            <option value="">Select a class...</option>
          </select>
        </div>

        <button class="btn block" id="next-btn" disabled>Next</button>
      </div>

      <!-- Assessment Screen 2 (previously screen2) -->
      <div id="screen2" class="screen">
        <div class="topbar">
          <div class="inline-actions">
            <button class="btn secondary" id="back-btn">Back</button>
          </div>
          <button class="btn secondary" id="refresh-btn-2">Refresh</button>
        </div>

        <div class="question">
          <label class="question-label">Skill</label>
          <select id="skill-select">
            <option value="">Select a skill...</option>
          </select>
        </div>

        <div class="question">
          <div class="roster-label" id="roster-name" style="display:none;"></div>

          <!-- Multi-select student control -->
          <label class="question-label">Students</label>
          <div class="ms-wrapper">
            <div class="selectlike ms-button" id="ms-button">Select students‚Ä¶</div>
            <div class="ms-panel" id="ms-panel"></div>
          </div>
          <div class="selected-list" id="selected-list"></div>
        </div>

        <div id="skill-attributes" class="skill-attributes" style="display:none;"></div>

        <button class="btn block" id="submit-btn" disabled>Submit Score</button>
      </div>
    </div>
  </div>

  <!-- Success Popup -->
  <div class="overlay" id="overlay"></div>
  <div class="success-popup" id="success-popup">
    <h3>‚úÖ <span id="success-message">Scores Saved</span></h3>
    <p id="success-detail">Choose new students or go back</p>
  </div>

  <script>
    // ===== CONFIG =====
    const SHEET_ID = '1vAemqH6f60Ly16e7fdMTDCbDudnY1xfu3IUXnMo6m0w';
    const API_KEY  = 'AIzaSyA3a5pz0sW2vL3-fLj-zH7o7xY2sXQcYD8';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz_WgHTO64_2IUj_XnLeHpX80x25NRHsTlM9S5VfqkdJPk_2JxNGZfgocx0s_ScK6FsBA/exec';

    // ===== OFFLINE + CACHE KEYS =====
    const CACHE_KEY = 'assessment_app_cache_v1';
    const QUEUE_KEY = 'assessment_app_queue_v1';

    // ===== STATE =====
    const state = {
      teachers: [],
      classes: [],
      skills: [],
      skillAttributes: [],
      studentsByClass: {}, // { className: [students...] }
      selectedTeacher: '',
      selectedClass: '',
      selectedSkill: '',
      selectedStudents: new Set(),
      counts: {}, // { studentName: number } for current teacher+skill
      selectedEmailRoster: '',
      selectedEmailSkill: '',
    };

    // ===== UTIL =====
    const isOnline = () => navigator.onLine;
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = message;
      el.style.display = 'block';
    }
    function showSuccessPopup(message = 'Scores Saved', detail = 'Choose new students or go back') {
      document.getElementById('success-message').textContent = message;
      document.getElementById('success-detail').textContent = detail;
      document.getElementById('overlay').classList.add('show');
      document.getElementById('success-popup').classList.add('show');
      setTimeout(() => {
        document.getElementById('overlay').classList.remove('show');
        document.getElementById('success-popup').classList.remove('show');
      }, 2000);
    }
    function setOfflineBanner() {
      const b = document.getElementById('offline-banner');
      b.style.display = isOnline() ? 'none' : 'inline-block';
    }
    window.addEventListener('online',  () => { setOfflineBanner(); flushQueue(); });
    window.addEventListener('offline', () => { setOfflineBanner(); });

    // ===== CACHE =====
    function loadCache() {
      try { return JSON.parse(localStorage.getItem(CACHE_KEY) || 'null'); } catch { return null; }
    }
    function saveCache(obj) {
      try { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); } catch {}
    }
    function cacheIsStale(cache) {
      if (!cache || !cache.timestamp) return true;
      const then = new Date(cache.timestamp).getTime();
      const now  = Date.now();
      const ONE_DAY = 24 * 60 * 60 * 1000;
      return (now - then) > ONE_DAY;
    }

    // ===== JSONP for counts and email sending =====
    function jsonp(url, params = {}) {
      return new Promise((resolve, reject) => {
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        params.callback = cbName;
        const qs = Object.entries(params).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
        const script = document.createElement('script');
        script.src = `${url}?${qs}`;
        script.async = true;

        let timeout = setTimeout(() => {
          delete window[cbName];
          script.remove();
          reject(new Error('JSONP timeout'));
        }, 12000);

        window[cbName] = (data) => {
          clearTimeout(timeout);
          delete window[cbName];
          script.remove();
          resolve(data);
        };

        script.onerror = () => {
          clearTimeout(timeout);
          delete window[cbName];
          script.remove();
          reject(new Error('JSONP error'));
        };

        document.body.appendChild(script);
      });
    }

    async function fetchCountsFor(teacher, skill, students) {
      if (!teacher || !skill || !students?.length) return {};
      try {
        const data = await jsonp(WEB_APP_URL, {
          fn: 'counts',
          teacher,
          skill,
          students: students.join('|'),
        });
        if (!data || !data.ok) return {};
        return data.counts || {};
      } catch {
        return {};
      }
    }

    async function sendEmailToRoster(roster, skill) {
      if (!roster || !skill) return { ok: false, error: 'Missing roster or skill' };
      try {
        const data = await jsonp(WEB_APP_URL, {
          fn: 'sendemail',
          roster,
          skill,
        });
        return data;
      } catch (error) {
        return { ok: false, error: error.toString() };
      }
    }

    // ===== SHEETS READS (public API) =====
    async function fetchSheetRange(sheetName, range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}!${range}?key=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Sheets API ${res.status}`);
      return await res.json();
    }

    // ===== WRITES (queue-aware) =====
    function loadQueue()  { try { return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); } catch { return []; } }
    function saveQueue(a) { try { localStorage.setItem(QUEUE_KEY, JSON.stringify(a)); } catch {} }

    async function submitToSheets(assessmentData) {
      if (!isOnline()) {
        const q = loadQueue(); q.push(assessmentData); saveQueue(q);
        return { success: true, queued: true };
      }
      try {
        await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(assessmentData),
        });
        return { success: true };
      } catch {
        const q = loadQueue(); q.push(assessmentData); saveQueue(q);
        return { success: true, queued: true };
      }
    }

    async function flushQueue() {
      if (!isOnline()) return;
      let q = loadQueue();
      if (!q.length) return;
      const remaining = [];
      for (const item of q) {
        try {
          await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
        } catch {
          remaining.push(item);
        }
      }
      saveQueue(remaining);
    }

    // ===== STARTUP =====
    document.addEventListener('DOMContentLoaded', () => {
      setOfflineBanner();
      initApp();

      // Home screen buttons
      document.getElementById('assess-btn').addEventListener('click', () => showScreen('screen1'));
      document.getElementById('email-btn').addEventListener('click', () => {
        populateEmailDropdowns();
        showScreen('email-screen');
      });

      // Refresh buttons
      document.getElementById('refresh-btn-home').addEventListener('click', () => manualRefresh());
      document.getElementById('refresh-btn-1').addEventListener('click', () => manualRefresh());
      document.getElementById('refresh-btn-2').addEventListener('click', () => manualRefresh());
      document.getElementById('refresh-btn-email').addEventListener('click', () => manualRefresh());

      // Back buttons
      document.getElementById('back-btn-assess').addEventListener('click', () => showScreen('home-screen'));
      document.getElementById('back-btn-email').addEventListener('click', () => showScreen('home-screen'));
      document.getElementById('back-btn').addEventListener('click', () => showScreen('screen1'));

      // Email screen handlers
      const emailRosterSelect = document.getElementById('email-roster-select');
      const emailSkillSelect = document.getElementById('email-skill-select');
      const sendEmailBtn = document.getElementById('send-email-btn');

      function checkEmailScreenComplete() {
        const isComplete = emailRosterSelect.value && emailSkillSelect.value;
        sendEmailBtn.disabled = !isComplete;
        if (isComplete) {
          sendEmailBtn.classList.add('enabled');
        } else {
          sendEmailBtn.classList.remove('enabled');
        }
      }

      emailRosterSelect.addEventListener('change', e => {
        state.selectedEmailRoster = e.target.value;
        checkEmailScreenComplete();
      });

      emailSkillSelect.addEventListener('change', e => {
        state.selectedEmailSkill = e.target.value;
        checkEmailScreenComplete();
      });

      sendEmailBtn.addEventListener('click', async () => {
        if (!isOnline()) {
          alert('You must be online to send emails. Please connect to the internet and try again.');
          return;
        }

        sendEmailBtn.disabled = true;
        sendEmailBtn.textContent = 'Sending...';

        const result = await sendEmailToRoster(state.selectedEmailRoster, state.selectedEmailSkill);
        
        if (result.ok) {
          showSuccessPopup('Emails Sent!', `Successfully sent to ${result.emailsSent} recipient(s)`);
          setTimeout(() => {
            // Reset email form and go back to home
            emailRosterSelect.value = '';
            emailSkillSelect.value = '';
            state.selectedEmailRoster = '';
            state.selectedEmailSkill = '';
            checkEmailScreenComplete();
            showScreen('home-screen');
          }, 2000);
        } else {
          alert('Error sending emails: ' + (result.error || 'Unknown error'));
        }

        sendEmailBtn.textContent = 'Send Email';
        checkEmailScreenComplete();
      });

      // Assessment Screen 1 handlers
      const teacherSelect = document.getElementById('teacher-select');
      const classSelect   = document.getElementById('class-select');
      const nextBtn       = document.getElementById('next-btn');

      function checkScreen1Complete() {
        nextBtn.disabled = !(teacherSelect.value && classSelect.value);
      }
      teacherSelect.addEventListener('change', e => { state.selectedTeacher = e.target.value; checkScreen1Complete(); });
      classSelect.addEventListener('change',   e => { state.selectedClass   = e.target.value; checkScreen1Complete(); });

      nextBtn.addEventListener('click', async () => {
        await ensureStudentsForClass(state.selectedClass);
        updateRosterLabel();
        await refreshCountsAndRender();
        showScreen('screen2');
        checkScreen2Complete();
      });

      // Assessment Screen 2 handlers
      const skillSelect = document.getElementById('skill-select');
      skillSelect.addEventListener('change', async (e) => {
        state.selectedSkill = e.target.value;
        showSkillAttributes();
        await refreshCountsAndRender();
        checkScreen2Complete();
      });

      // Multi-select open/close with suppression so it stays open on clicks
      let suppressCloseOnce = false;
      const msButton = document.getElementById('ms-button');
      const msPanel  = document.getElementById('ms-panel');

      msButton.addEventListener('click', (e) => {
        e.stopPropagation();
        msPanel.classList.toggle('show');
      });
      document.addEventListener('click', (e) => {
        if (suppressCloseOnce) { suppressCloseOnce = false; return; }
        if (!msPanel.contains(e.target) && e.target !== msButton) msPanel.classList.remove('show');
      });

      // expose suppression + re-render flag to item clicks
      window._ms_keepOpen = () => { suppressCloseOnce = true; };

      document.getElementById('submit-btn').addEventListener('click', submitAssessment);
    });

    async function initApp() {
      showScreen('loading-screen');

      let cache = loadCache();
      const needOnline = !cache || cacheIsStale(cache);

      if (needOnline && isOnline()) {
        await refreshAllDataOnline();
      } else if (cache) {
        restoreFromCache(cache);
      } else {
        showError('No cached data and offline. Connect to the internet and press Refresh.');
        return;
      }

      populateDropdowns();
      showScreen('home-screen'); // Changed to show home screen first

      // auto refresh once per day when back online
      if (!needOnline && cacheIsStale(loadCache()) && isOnline()) {
        await refreshAllDataOnline();
        populateDropdowns();
      }

      flushQueue();
    }

    async function manualRefresh() {
      if (!isOnline()) return;
      await refreshAllDataOnline(true);
      populateDropdowns();
      populateEmailDropdowns();
      if (state.selectedClass) {
        await ensureStudentsForClass(state.selectedClass, true);
        await refreshCountsAndRender(true);
      }
    }

    function restoreFromCache(cache) {
      state.teachers        = cache.teachers || [];
      state.classes         = cache.classes || [];
      state.skills          = cache.skills || [];
      state.skillAttributes = cache.skillAttributes || [];
      state.studentsByClass = cache.studentsByClass || {};
    }

    // Prefetch ALL rosters' students when online so offline lists work
    async function refreshAllDataOnline(force=false) {
      const teachersData = await fetchSheetRange('List Builders', 'B1:BF1');
      const classesData  = await fetchSheetRange('Group Builder', 'B1:BF1');
      const skillsData   = await fetchSheetRange('Survey Sender', 'B2:K2');
      const attrsData    = await fetchSheetRange('Survey Sender', 'B3:K12');

      state.teachers        = teachersData.values?.[0]?.filter(v => v && String(v).trim() !== '') || [];
      state.classes         = classesData.values?.[0]?.filter(v => v && String(v).trim() !== '') || [];
      state.skills          = skillsData.values?.[0]?.filter(v => v && String(v).trim() !== '') || [];
      state.skillAttributes = attrsData.values || [];

      // Prefetch students for ALL classes
      state.studentsByClass = {};
      const headerData = await fetchSheetRange('Group Builder', 'B1:BF1');
      const headers = headerData.values?.[0] || [];
      const toA1 = (n) => { let s=''; while (n>0){ const m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=Math.floor((n-1)/26);} return s; };

      for (const className of state.classes) {
        const idx = headers.findIndex(h => h && String(h).trim() === className);
        if (idx === -1) { state.studentsByClass[className] = []; continue; }
        const colLetter = toA1(idx + 2); // B=2
        const studentsData = await fetchSheetRange('Group Builder', `${colLetter}3:${colLetter}300`);
        const list = studentsData.values ? studentsData.values.flat().filter(v => v && String(v).trim() !== '') : [];
        state.studentsByClass[className] = list;
      }

      saveCache({
        timestamp: new Date().toISOString(),
        teachers: state.teachers,
        classes: state.classes,
        skills: state.skills,
        skillAttributes: state.skillAttributes,
        studentsByClass: state.studentsByClass,
      });
    }

    async function ensureStudentsForClass(className, force=false) {
      const cache = loadCache();
      const cachedList = cache?.studentsByClass?.[className];

      if (!force && Array.isArray(cachedList) && cachedList.length) {
        state.studentsByClass[className] = cachedList;
        return;
      }

      if (!isOnline()) {
        state.studentsByClass[className] = cachedList || [];
        return;
      }

      // Online fetch for one class + update cache
      const headerData = await fetchSheetRange('Group Builder', 'B1:BF1');
      const allColumns = headerData.values?.[0] || [];
      const idx = allColumns.findIndex(h => h && String(h).trim() === className);
      if (idx === -1) { state.studentsByClass[className] = []; return; }

      const toA1 = (n) => { let s=''; while (n>0){ const m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=Math.floor((n-1)/26);} return s; };
      const colLetter = toA1(idx + 2);
      const studentsData = await fetchSheetRange('Group Builder', `${colLetter}3:${colLetter}300`);
      const list = studentsData.values ? studentsData.values.flat().filter(v => v && String(v).trim() !== '') : [];
      state.studentsByClass[className] = list;

      const newCache = loadCache() || { studentsByClass: {} };
      newCache.studentsByClass = newCache.studentsByClass || {};
      newCache.studentsByClass[className] = list;
      newCache.timestamp = new Date().toISOString();
      saveCache(newCache);
    }

    function populateDropdowns() {
      const teacherSelect = document.getElementById('teacher-select');
      const classSelect   = document.getElementById('class-select');
      const skillSelect   = document.getElementById('skill-select');

      teacherSelect.innerHTML = '<option value="">Select a teacher...</option>';
      classSelect.innerHTML   = '<option value="">Select a class...</option>';
      skillSelect.innerHTML   = '<option value="">Select a skill...</option>';

      state.teachers.forEach(v => {
        const o = document.createElement('option'); o.value = v; o.textContent = v; teacherSelect.appendChild(o);
      });
      state.classes.forEach(v => {
        const o = document.createElement('option'); o.value = v; o.textContent = v; classSelect.appendChild(o);
      });
      state.skills.forEach(v => {
        const o = document.createElement('option'); o.value = v; o.textContent = v; skillSelect.appendChild(o);
      });
    }

    function populateEmailDropdowns() {
      const emailRosterSelect = document.getElementById('email-roster-select');
      const emailSkillSelect = document.getElementById('email-skill-select');

      emailRosterSelect.innerHTML = '<option value="">Select a roster...</option>';
      emailSkillSelect.innerHTML = '<option value="">Select a skill...</option>';

      // Rosters are the same as classes
      state.classes.forEach(v => {
        const o = document.createElement('option'); o.value = v; o.textContent = v; emailRosterSelect.appendChild(o);
      });
      
      // Skills
      state.skills.forEach(v => {
        const o = document.createElement('option'); o.value = v; o.textContent = v; emailSkillSelect.appendChild(o);
      });
    }

    function updateRosterLabel() {
      const el = document.getElementById('roster-name');
      if (state.selectedClass) {
        el.textContent = `Roster: ${state.selectedClass}`;
        el.style.display = 'block';
      } else {
        el.style.display = 'none';
      }
    }

    // Show skill attributes
    function showSkillAttributes() {
      const c = document.getElementById('skill-attributes');
      c.innerHTML = '';
      c.style.display = 'block';

      const idx = state.skills.indexOf(state.selectedSkill);
      if (idx === -1) return;

      const rows = state.skillAttributes || [];
      const col = Array.from({ length: 10 }, (_, r) => {
        const row = rows[r] || [];
        return (row[idx] || '').toString().trim();
      });

      col.forEach((attribute, index) => {
        const item = document.createElement('div');
        item.className = 'attribute-item';
        item.dataset.index = index;
        item.innerHTML = `
          <div class="attribute-checkbox"></div>
          <div class="attribute-text">${attribute || `<em>‚Äî</em>`}</div>
        `;
        item.addEventListener('click', () => {
          if (!attribute) return;
          item.classList.toggle('checked');
        });
        c.appendChild(item);
      });
    }

    // Multi-select (with counts)
    function renderStudentMultiselect(keepOpen = false) {
      const panel = document.getElementById('ms-panel');
      const btn   = document.getElementById('ms-button');
      const list  = state.studentsByClass[state.selectedClass] || [];
      panel.innerHTML = '';

      if (list.length === 0) {
        panel.innerHTML = `<div class="ms-item" style="color:#6b7280;">
          ${isOnline() ? 'No students found for this roster.' : 'No cached students for this roster (offline). Go online and press Refresh.'}
        </div>`;
        btn.textContent = 'Select students‚Ä¶';
        if (keepOpen) panel.classList.add('show');
        return;
      }

      list.forEach(name => {
        const count = state.counts[name] || 0;
        const item = document.createElement('div');
        item.className =
          'ms-item ' +
          (state.selectedStudents.has(name) ? 'selected ' : '') +
          (count === 0 ? 'zero' : 'nonzero');

        item.innerHTML = `
          <div class="ms-name">${name}</div>
          <div class="ms-count">(${count})</div>
        `;

        // Keep panel open after each selection
        item.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (state.selectedStudents.has(name)) state.selectedStudents.delete(name);
          else state.selectedStudents.add(name);

          window._ms_keepOpen();             // one-shot suppression for the document click handler
          renderStudentMultiselect(true);    // re-render AND keep open
          renderSelectedList();
          checkScreen2Complete();
        });

        panel.appendChild(item);
      });

      // Update button label
      const n = state.selectedStudents.size;
      btn.textContent = n ? `${n} selected` : 'Select students‚Ä¶';

      if (keepOpen) panel.classList.add('show');
    }

    function renderSelectedList() {
      const wrap = document.getElementById('selected-list');
      wrap.innerHTML = '';
      if (!state.selectedStudents.size) return;
      [...state.selectedStudents].forEach(name => {
        const row = document.createElement('div');
        row.className = 'selected-row';
        row.innerHTML = `
          <div>${name} <span style="color:#6b7280;">(${state.counts[name] || 0})</span></div>
          <div class="remove-link">remove</div>
        `;
        row.querySelector('.remove-link').addEventListener('click', () => {
          state.selectedStudents.delete(name);
          renderStudentMultiselect(true);
          renderSelectedList();
          checkScreen2Complete();
        });
        wrap.appendChild(row);
      });
    }

    async function refreshCountsAndRender(force=false) {
      const cls = state.selectedClass;
      const list = state.studentsByClass[cls] || [];

      if (!state.selectedTeacher || !state.selectedSkill || list.length === 0) {
        state.counts = {};
        renderStudentMultiselect();
        renderSelectedList();
        return;
      }

      if (!isOnline()) {
        state.counts = {};
        renderStudentMultiselect();
        renderSelectedList();
        return;
      }

      try {
        state.counts = await fetchCountsFor(state.selectedTeacher, state.selectedSkill, list);
      } catch { state.counts = {}; }

      renderStudentMultiselect();
      renderSelectedList();
    }

    function checkScreen2Complete() {
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = !(state.selectedSkill && state.selectedStudents.size > 0);
    }

    // Submit
    async function submitAssessment() {
      const attributeItems = document.querySelectorAll('.attribute-item');
      const checkedAttributes = [];
      attributeItems.forEach(item => {
        if (item.classList.contains('checked')) {
          const txt = item.querySelector('.attribute-text').textContent;
          checkedAttributes.push(txt);
        } else {
          checkedAttributes.push('');
        }
      });
      while (checkedAttributes.length < 10) checkedAttributes.push('');
      if (checkedAttributes.length > 10) checkedAttributes.length = 10;

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = isOnline() ? 'Saving‚Ä¶' : 'Saving (queued)‚Ä¶';

      const students = [...state.selectedStudents];
      for (const student of students) {
        const payload = {
          teacher: state.selectedTeacher,
          student,
          skill: state.selectedSkill,
          attributes: checkedAttributes
        };
        await submitToSheets(payload);
        state.counts[student] = (state.counts[student] || 0) + 1; // optimistic
      }

      state.selectedStudents.clear();
      renderStudentMultiselect(true);
      renderSelectedList();
      checkScreen2Complete();

      // NEW: clear the attribute checkboxes so they're reset for next student(s)
      document.querySelectorAll('.attribute-item.checked').forEach(el => el.classList.remove('checked'));

      submitBtn.textContent = 'Submit Score';
      showSuccessPopup();
    }
  </script>
</body>
</html>
