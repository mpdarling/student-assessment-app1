<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Assessment" />
  <title>Student Assessment App</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 420px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; min-height: calc(100vh - 40px); }
    .header { background: #2563eb; color: white; padding: 16px 20px; text-align: center; position: relative; }
    .header h1 { font-size: 22px; font-weight: 700; }
    .header p { opacity: 0.95; font-size: 13px; }
    .offline-banner { margin-top: 8px; background: #f59e0b; color: #111827; font-weight: 600; padding: 6px 10px; border-radius: 10px; display: none; }
    .content { padding: 24px 18px 28px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .question { margin-bottom: 16px; }
    .question-label { display: block; font-weight: 700; color: #1e40af; margin-bottom: 6px; font-size: 15px; }
    select, .selectlike {
      width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white; transition: border-color 0.2s; cursor: pointer;
    }
    select:focus, .selectlike:focus { outline: none; border-color: #2563eb; }
    .btn { padding: 10px 14px; background: #2563eb; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .btn:hover { background: #1d4ed8; }
    .btn.secondary { background: #6b7280; }
    .btn.secondary:hover { background: #4b5563; }
    .btn.block { width: 100%; padding: 16px; border-radius: 12px; font-size: 18px; margin-top: 16px; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .skill-attributes { margin-top: 12px; }
    .attribute-item { display: flex; align-items: center; padding: 10px; margin: 6px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: #fef2f2; border: 2px solid #fca5a5; }
    .attribute-item.checked { background: #f0fdf4; border-color: #4ade80; }
    .attribute-checkbox { width: 18px; height: 18px; border-radius: 6px; border: 2px solid #fca5a5; background: white; margin-right: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .attribute-item.checked .attribute-checkbox { background: #4ade80; border-color: #4ade80; }
    .attribute-checkbox::after { content: '✓'; color: white; font-weight: 700; opacity: 0; transition: opacity 0.2s; font-size: 12px; }
    .attribute-item.checked .attribute-checkbox::after { opacity: 1; }
    .attribute-text { flex: 1; font-weight: 500; }
    .loading { text-align: center; padding: 32px 20px; color: #6b7280; }
    .error { background: #fef2f2; border: 1px solid #fca5a5; color: #dc2626; padding: 12px; border-radius: 8px; margin: 10px 0; }
    .success-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 26px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 1000; text-align: center; display: none; }
    .success-popup.show { display: block; }
    .success-popup h3 { color: #059669; margin-bottom: 8px; }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
    .overlay.show { display: block; }
    .roster-label { font-size: 14px; color: #374151; margin: -2px 0 10px 0; }
    .inline-actions { display: flex; gap: 8px; }
    .ms-wrapper { position: relative; }
    .ms-button { display: flex; align-items: center; justify-content: space-between; }
    .ms-panel {
      position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: #fff; border: 2px solid #e5e7eb;
      border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.12); max-height: 260px; overflow: auto; z-index: 30; display: none;
    }
    .ms-panel.show { display: block; }
    .ms-item { padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .ms-item:hover { background: #f3f4f6; }
    .ms-item.selected { background: #eff6ff; }
    .ms-count { font-size: 12px; margin-left: 10px; color: #6b7280; }
    .ms-item.zero .ms-name { color: #111827; font-weight: 600; }
    .ms-item.nonzero .ms-name { color: #6b7280; }
    .selected-list { margin-top: 8px; }
    .selected-row { padding: 6px 8px; border: 1px dashed #e5e7eb; border-radius: 8px; margin: 4px 0; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .remove-link { color: #2563eb; font-weight: 700; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Student Assessment</h1>
      <p>Evaluate student skills and progress</p>
      <div class="offline-banner" id="offline-banner">Offline Mode</div>
    </div>

    <div class="content">
      <!-- Loading Screen -->
      <div id="loading-screen" class="screen active">
        <div class="loading">
          <p>Loading data from spreadsheet...</p>
          <div id="error-message" class="error" style="display:none;"></div>
        </div>
      </div>

      <!-- Home Screen -->
      <div id="home-screen" class="screen">
        <div class="topbar">
          <div></div>
          <button class="btn secondary" id="refresh-btn-home">Refresh</button>
        </div>
        <div style="display:grid; gap:12px; margin-top:8px;">
          <button class="btn block" id="btn-assess">Assess Students</button>
          <button class="btn block" id="btn-email">Email Students Assessment Link</button>
        </div>
      </div>

      <!-- Screen 1: Teacher + Class -->
      <div id="screen1" class="screen">
        <div class="topbar">
          <div class="inline-actions">
            <button class="btn secondary" id="screen1-back-btn">Back</button>
          </div>
          <button class="btn secondary" id="refresh-btn-1">Refresh</button>
        </div>

        <div class="question">
          <label class="question-label">Who are you?</label>
          <select id="teacher-select">
            <option value="">Select a teacher...</option>
          </select>
        </div>

        <div class="question">
          <label class="question-label">Which group (roster) do you want to assess?</label>
          <select id="class-select">
            <option value="">Select a class...</option>
          </select>
        </div>

        <button class="btn block" id="next-btn" disabled>Next</button>
      </div>

      <!-- Screen 2: Skill + Students + Attributes -->
      <div id="screen2" class="screen">
        <div class="topbar">
          <div class="inline-actions">
            <button class="btn secondary" id="back-btn">Back</button>
          </div>
          <button class="btn secondary" id="refresh-btn-2">Refresh</button>
        </div>

        <div class="question">
          <label class="question-label">Skill</label>
          <select id="skill-select">
            <option value="">Select a skill...</option>
          </select>
        </div>

        <div class="question">
          <div class="roster-label" id="roster-name" style="display:none;"></div>
          <label class="question-label">Students</label>
          <div class="ms-wrapper">
            <div class="selectlike ms-button" id="ms-button">Select students…</div>
            <div class="ms-panel" id="ms-panel"></div>
          </div>
          <div class="selected-list" id="selected-list"></div>
        </div>

        <div id="skill-attributes" class="skill-attributes" style="display:none;"></div>

        <button class="btn block" id="submit-btn" disabled>Submit Score</button>
      </div>

      <!-- Screen 3: Email Students -->
      <div id="email-screen" class="screen">
        <div class="topbar">
          <div class="inline-actions">
            <button class="btn secondary" id="email-back-btn">Back</button>
          </div>
          <button class="btn secondary" id="refresh-btn-email">Refresh</button>
        </div>

        <div class="question">
          <label class="question-label">Choose Roster</label>
          <select id="email-class-select">
            <option value="">Select a class...</option>
          </select>
        </div>

        <div class="question">
          <label class="question-label">Choose Skill</label>
          <select id="email-skill-select">
            <option value="">Select a skill...</option>
          </select>
        </div>

        <button class="btn block" id="send-email-btn" disabled>Send Email</button>
      </div>
    </div>
  </div>

  <!-- Success Popup -->
  <div class="overlay" id="overlay"></div>
  <div class="success-popup" id="success-popup">
    <h3 id="popup-text">✅ Saved</h3>
    <p>Returning to Home...</p>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbypa7WSfQANS5COT0T4ADMhKZApdGiwugrpAn0PSlU51IslPoiIJ_0ZdSkk_3K9_KNxDA/exec'; // replace after deployment

    const state = {
      teachers: [],
      classes: [],
      skills: [],
      selectedTeacher: '',
      selectedClass: '',
      selectedSkill: '',
    };

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    function showPopup(message) {
      document.getElementById('popup-text').textContent = message;
      document.getElementById('overlay').classList.add('show');
      document.getElementById('success-popup').classList.add('show');
      setTimeout(() => {
        document.getElementById('overlay').classList.remove('show');
        document.getElementById('success-popup').classList.remove('show');
        showScreen('home-screen');
      }, 2000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Nav
      document.getElementById('btn-assess').addEventListener('click', () => showScreen('screen1'));
      document.getElementById('btn-email').addEventListener('click', () => showScreen('email-screen'));

      document.getElementById('screen1-back-btn').addEventListener('click', () => showScreen('home-screen'));
      document.getElementById('back-btn').addEventListener('click', () => showScreen('screen1'));
      document.getElementById('email-back-btn').addEventListener('click', () => showScreen('home-screen'));

      // Email dropdown logic
      const emailClassSelect = document.getElementById('email-class-select');
      const emailSkillSelect = document.getElementById('email-skill-select');
      const sendEmailBtn = document.getElementById('send-email-btn');

      function checkEmailComplete() {
        sendEmailBtn.disabled = !(emailClassSelect.value && emailSkillSelect.value);
      }
      emailClassSelect.addEventListener('change', checkEmailComplete);
      emailSkillSelect.addEventListener('change', checkEmailComplete);

      sendEmailBtn.addEventListener('click', async () => {
        sendEmailBtn.disabled = true;
        sendEmailBtn.textContent = 'Sending...';
        const payload = {
          action: 'email_students',
          roster: emailClassSelect.value,
          skill: emailSkillSelect.value
        };
        try {
          await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          showPopup('✅ Email Sent');
        } catch {
          showPopup('⚠️ Failed to send');
        }
        sendEmailBtn.textContent = 'Send Email';
        sendEmailBtn.disabled = false;
      });

      // TODO: Populate teachers/classes/skills via Sheets API as before
      showScreen('home-screen');
    });
  </script>
</body>
</html>
